<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Ranking — The Curry Chronicles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="h-full bg-black text-gray-200 font-inter flex flex-col">
    <div class="container mx-auto px-4 py-6">
        <header class="flex items-center justify-between mb-6">
            <a href="index.html" class="nav-link font-playfair text-2xl">The Curry Chronicles</a>
            <nav>
                <ul class="hidden md:flex items-center space-x-6">
                    <li><a href="about.html" class="nav-link">About</a></li>
                    <li><a href="contact.html" class="nav-link">Contact</a></li>
                    <li><a href="live-ranking.html" class="nav-link active">Live Ranking</a></li>
                    <li><a href="signup.html" class="nav-link">Sign Up</a></li>
                </ul>
            </nav>
        </header>

        <section>
            <h2 class="text-3xl font-playfair mb-2">Mumbai — Top 100 Restaurants (Live)</h2>
            <p class="text-gray-400 mb-6">Browse the top 100 restaurants overall or by category. Tables refresh automatically.</p>

      <div class="mb-4 flex items-center gap-4">
        <div class="flex gap-2" role="tablist" aria-label="Ranking categories">
          <button data-cat="overall" class="cat-btn bg-amber-600 text-black px-3 py-1 rounded">Overall</button>
          <button data-cat="food" class="cat-btn bg-black border border-gray-700 text-gray-300 px-3 py-1 rounded">Food</button>
          <button data-cat="service" class="cat-btn bg-black border border-gray-700 text-gray-300 px-3 py-1 rounded">Service</button>
          <button data-cat="ambience" class="cat-btn bg-black border border-gray-700 text-gray-300 px-3 py-1 rounded">Ambience</button>
          <button data-cat="time" class="cat-btn bg-black border border-gray-700 text-gray-300 px-3 py-1 rounded">Time</button>
          <button data-cat="accessibility" class="cat-btn bg-black border border-gray-700 text-gray-300 px-3 py-1 rounded">Accessibility</button>
        </div>
                <a href="review.html" class="ml-auto bg-amber-600 hover:bg-amber-700 px-3 py-1 rounded text-sm">Go to Review</a>
            </div>

            <div id="tables-wrap" class="space-y-6">
              <div class="overflow-hidden bg-black rounded">
                <div class="p-3 border-b border-gray-700">Top 100 — Filtered list</div>
                <div class="p-0 bg-black">
                  <table id="table-main" class="w-full text-sm table-auto">
                    <thead class="sticky top-0 bg-gray-900">
                      <tr class="text-left text-xs text-gray-400">
                        <th class="px-4 py-2">#</th>
                        <th class="px-4 py-2">Photo</th>
                        <th class="px-4 py-2">Restaurant</th>
                        <th class="px-4 py-2">Score</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
        </section>
    </div>
    <!-- modal for image preview -->
    <div id="img-modal" aria-hidden="true" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70">
      <div class="max-w-3xl w-full mx-4">
        <button id="modal-close" class="mb-2 text-white">Close ✕</button>
        <div class="bg-black p-4 rounded">
          <img id="modal-img" src="" alt="Preview" class="w-full rounded" />
        </div>
      </div>
    </div>

    <script src="external-images.js"></script>
    <script src="restaurants-data.js"></script>
    <script>
    (function(){
        const restaurants = window.restaurants || [];
        const cats = ['food','service','ambience','time','accessibility'];
        const STORAGE_KEY = 'mumbai_restaurant_ratings_v1';

        function getApiBases() { try { return [window.location.origin, 'http://localhost:3000'].filter(Boolean); } catch(e){ return ['http://localhost:3000']; } }
        async function tryFetchOnBases(path, options){ for(const b of getApiBases()){ try{ const res = await fetch(b.replace(/\/$/, '')+path, options); if(res && res.ok) return res; }catch(e){} } return null; }

        async function fetchStatsFromServer(){ try{ const res = await tryFetchOnBases('/api/stats'); if(!res) return null; return await res.json(); }catch(e){ return null; } }
        function loadRatings(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw? JSON.parse(raw): {}; }catch(e){ return {}; } }

        function formatNum(v){ return (v===null||v===undefined) ? '—' : (Math.round(v*10)/10).toFixed(1); }

  // small inline SVG fallback (data URL) to use when external image fails to load
  const __imgFallback = 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="160" height="120"><rect width="100%" height="100%" fill="#0f172a"/><text x="50%" y="50%" fill="#9ca3af" font-family="Arial, sans-serif" font-size="14" dominant-baseline="middle" text-anchor="middle">No image</text></svg>`);

  function fillTableMain(rows){ const tbody = document.querySelector('#table-main tbody'); tbody.innerHTML=''; rows.forEach((r,idx)=>{ const tr = document.createElement('tr'); tr.className = idx%2? 'bg-neutral-900':'bg-black'; const pos = document.createElement('td'); pos.className='px-4 py-2'; pos.textContent = (idx+1).toString();

    // thumbnail cell
    const thumbCell = document.createElement('td'); thumbCell.className = 'px-4 py-2';
    const wrap = document.createElement('div'); wrap.className = 'w-[80px] h-[60px] overflow-hidden rounded-md';
    const img = document.createElement('img');
    img.alt = r.name || 'restaurant';
    img.loading = 'lazy';
    img.width = 160; img.height = 120; // natural size for sharper rendering
    img.style.objectFit = 'cover';
    img.style.width = '100%'; img.style.height = '100%';
    img.style.display = 'block'; img.style.cursor = 'zoom-in';
    // lookup thumb URL from the global restaurants array (restaurants defined earlier)
    try { img.src = (restaurants.find(rr=>rr.id===r.id) || {}).imgThumb || __imgFallback; } catch(e){ img.src = __imgFallback; }
    img.onerror = function(){ this.onerror = null; this.src = __imgFallback; };
    // open modal with large image on click
    img.addEventListener('click', ()=>{
      const modal = document.getElementById('img-modal');
      const modalImg = document.getElementById('modal-img');
      const source = (restaurants.find(rr=>rr.id===r.id) || {}).imgLarge || __imgFallback;
      modalImg.src = source;
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    });
    wrap.appendChild(img);
    thumbCell.appendChild(wrap);

    const name = document.createElement('td'); name.className='px-4 py-2'; const a = document.createElement('a'); a.href = `restaurant.html?id=${r.id}`; a.textContent = r.name; a.className = 'text-amber-300 hover:underline'; name.appendChild(a); const score = document.createElement('td'); score.className='px-4 py-2'; score.textContent = formatNum(r.score); tr.appendChild(pos); tr.appendChild(thumbCell); tr.appendChild(name); tr.appendChild(score); tbody.appendChild(tr); }); }

        async function renderAll(){ const serverStats = await fetchStatsFromServer(); const local = loadRatings(); const statsLookup = {};
            restaurants.forEach(r=>{ const s = serverStats && serverStats[r.id] ? serverStats[r.id] : (function(){ const arr = local[r.id]||[]; const count = arr.length; const avg = count? (arr.reduce((a,b)=>a+b,0)/count):0; return { count, avg, breakdown: null }; })(); statsLookup[r.id] = s; });

            // prepare overall and per-category lists
            const overallList = restaurants.map(r=>({ id: r.id, name: r.name, score: (statsLookup[r.id] && statsLookup[r.id].avg) || 0 }));
            overallList.sort((a,b)=>b.score - a.score);
            const categoryLists = { overall: overallList };
            cats.forEach(cat => {
              const list = restaurants.map(r=>({ id: r.id, name: r.name, score: (statsLookup[r.id] && statsLookup[r.id].breakdown && statsLookup[r.id].breakdown[cat]) || 0 }));
              list.sort((a,b)=>b.score - a.score);
              categoryLists[cat] = list;
            });

            window.__latestLists = categoryLists;
            // render default (overall)
            fillTableMain(categoryLists['overall'].slice(0,100));
        }

        document.addEventListener('DOMContentLoaded', ()=>{
          // category buttons
          document.querySelectorAll('.cat-btn').forEach(btn=> btn.addEventListener('click', async ()=>{
            document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('bg-amber-600','text-black'));
            btn.classList.add('bg-amber-600','text-black');
            const cat = btn.getAttribute('data-cat');
            if (!window.__latestLists) await renderAll();
            const list = window.__latestLists && window.__latestLists[cat] ? window.__latestLists[cat] : [];
            fillTableMain(list.slice(0,100));
            window.scrollTo({ top: document.querySelector('#tables-wrap').offsetTop - 20, behavior: 'smooth' });
          }));

          // initial load & polling
          (async ()=>{ await renderAll(); })();
          setInterval(async ()=>{ await renderAll(); }, 10000);
          // modal close handlers
          document.getElementById('modal-close').addEventListener('click', ()=>{
            const modal = document.getElementById('img-modal'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); document.getElementById('modal-img').src = '';
          });
          document.getElementById('img-modal').addEventListener('click', (ev)=>{
            if(ev.target === ev.currentTarget){ const modal = document.getElementById('img-modal'); modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); document.getElementById('modal-img').src = ''; }
          });
          document.addEventListener('keydown', (ev)=>{ if(ev.key === 'Escape'){ const modal = document.getElementById('img-modal'); if(!modal.classList.contains('hidden')){ modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true'); document.getElementById('modal-img').src = ''; } } });
          });
    })();
    </script>
</body>
</html>